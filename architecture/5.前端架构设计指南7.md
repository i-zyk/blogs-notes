# å‰ç«¯æ¶æ„è®¾è®¡æŒ‡å—7
dist ç›´æ¥éƒ¨ç½²åˆ°æœåŠ¡å™¨ï¼Œå°±ä¼šå‡ºç°404æƒ…å†µï¼Œå› ä¸ºè¿™æ˜¯ä¸€ä¸ªå‡è·¯ç”±ï¼Œéœ€è¦åšé€‚é…
ç”¨ngnixé…ç½®æ–¹å‘ä»£ç†ï¼Œä»£ç†åˆ°é¦–é¡µï¼›ç°åœ¨å¾ˆå°‘äººç”¨ngnixäº†ï¼Œé…ç½®å¤ªç¹çï¼Œç°åœ¨éƒ½æ˜¯æŠŠdistæ–‡ä»¶å¤¹ä¸‹çš„å†…å®¹ï¼Œç›´æ¥ä¸¢åˆ°ç½‘ç›˜ã€Œé˜¿é‡Œäº‘ossã€aws S3ã€

aws S3
+ åˆ›å»ºå­˜å‚¨æ¡¶ æŠŠ é˜»æ­¢æ‰€æœ‰å…¬å¼€è®¿é—® æ‰“å¼€ï¼Œç„¶åä¸Šä¼ æ–‡ä»¶å°±å¯ä»¥äº†
+ ç„¶åæƒ³è¦æ”¯æŒpushStateçš„è¯ï¼Œæ‰“å¼€ å±æ€§ä¸‹é¢çš„ é™æ€ç½‘ç«™æ‰˜ç®¡ å¯ç”¨å°±å¯ä»¥ä¸Šçº¿äº†
+ å¯åŠ¨é™æ€ç®¡ç†åï¼Œå¯ä»¥é…ç½®ä¸€ä¸‹é”™è¯¯ç´¢å¼•404é¡µé¢å’Œå…¶ä»–ä¸€äº›é¡µé¢
+ å¯ä»¥é…ç½®CloudFront - åˆ›å»ºåˆ†é…ã€Œæ‰¾åˆ°s3ç«™ç‚¹ã€å’Œæ ¹ç›®å½•ï¼Œç›´æ¥åˆ›å»ºã€
![åˆ›å»ºåˆ†é…](./imgs/7-1.png)

index-prod.html
reactè¦æ‰¾cdnä¸è¦è®©reactå‚ä¸æ„å»ºã€Œå¯ä»¥å…ˆç”¨ä¸ªå…è´¹çš„ï¼Œå…¬å¸é¡¹ç›®è¦ç”¨è‡ªå·±å…¬å¸å†…éƒ¨çš„ã€
```
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
</head>
<body>
    
</body>
</html>
```

index-prod.html
```
//å¼€å¯JSå¤šçº¿ç¨‹çš„å‹ç¼©
const TerserPlugin = require('terser-webpack-plugin');
const CssMinimizerPlugin = require('css-minimizer-webpack-plugin');
const { join, resolve } = require('path');
const HtmlWebpackPlugin = require('html-webpack-plugin');
//æ•´ç«™ç¦»çº¿ç¼“å­˜
// const WorkboxPlugin = require('workbox-webpack-plugin');

module.exports = {
  output: {
    path: join(__dirname, '../dist'),
    publicPath: '/',
    filename: 'scripts/[name].[contenthash:5].bundule.js',
    assetModuleFilename: 'images/[name].[contenthash:5][ext]',
  },
  experiments: {
    outputModule: true,
  },
  //æ€§èƒ½ï¼Œè¶…è¿‡é™åˆ¶æ— æ³•æ‰“åŒ…
  performance: {
    maxAssetSize: 250000, // æœ€å¤§èµ„æºå¤§å°250KB
    maxEntrypointSize: 250000,  // æœ€å¤§å…¥å£èµ„æºå¤§å°250KB
    hints: 'warning', // è¶…å‡ºé™åˆ¶æ—¶åªç»™å‡ºè­¦å‘Š
  },
  //å¤šçº¿ç¨‹çš„å‹ç¼©
  optimization: {
    minimize: true,
    minimizer: [
      new CssMinimizerPlugin({
        parallel: true,
      }),
      new TerserPlugin({
        parallel: true,
      })
    ]
  },
  //æ’é™¤reactåŒ…ï¼Œæ„å»ºé€Ÿåº¦ä¼šå¿«å¾ˆå¤š
+ externals: {
+   react: 'React',
+   'react-dom': 'ReactDOM',
+ },
  plugins: [
    // new WorkboxPlugin.GenerateSW({
    //   clientsClaim: true, // Service Worker æ¿€æ´»åç«‹å³æ§åˆ¶é¡µé¢
    //   skipWaiting: true, // è·³è¿‡ç­‰å¾…ï¼Œç›´æ¥æ¿€æ´»æ–°çš„ Service Worker
    //   // é¢„ç¼“å­˜çš„åŒ¹é…è§„åˆ™ï¼ˆé»˜è®¤ç¼“å­˜æ‰€æœ‰ Webpack è¾“å‡ºçš„æ–‡ä»¶ï¼‰
    //   include: [/\.html$/, /\.js$/, /\.css$/],
    //   // å¯é€‰ï¼šæ·»åŠ è¿è¡Œæ—¶ç¼“å­˜ç­–ç•¥
    //   runtimeCaching: [
    //     {
    //       urlPattern: /.\(?:png|jpg|jpeg|svg)$/, // åŒ¹é…å›¾ç‰‡èµ„æº
    //       handler: 'CacheFirst', // ä½¿ç”¨â€œç¼“å­˜ä¼˜å…ˆâ€ç­–ç•¥
    //       options: {
    //         cacheName: 'images', // ç¼“å­˜åç§°
    //         expiration: {
    //           maxEntries: 10, // æœ€å¤šç¼“å­˜ 10 ä¸ªæ–‡ä»¶
    //           maxAgeSeconds: 30 * 24 * 60 * 60, // ç¼“å­˜ 30 å¤©
    //         },
    //       },
    //     },
    //     {
    //       // API è¯·æ±‚ç¼“å­˜ç­–ç•¥
    //       urlPattern: /^https:\/\/api\./,
    //       handler: 'NetworkFirst',
    //       options: {
    //         cacheName: 'api-cache',
    //         networkTimeoutSeconds: 3,
    //         expiration: {
    //           maxEntries: 50,
    //           maxAgeSeconds: 5 * 60, // 5 åˆ†é’Ÿ
    //         },
    //       },
    //     },
    //   ]
    // }),
    new HtmlWebpackPlugin({
      title: 'Yideng',
      filename: 'index.html',
      template: resolve(__dirname, '../src/index-prod.html'),
      favicon: './public/favicon.ico',
    }),
  ],
};
```

3.MPAã€ŒKoaã€Nest.jsã€

+ BFFã€Œåº”ç”¨æä¾›å®šåˆ¶åŒ–çš„åç«¯æœåŠ¡ã€‚å®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯ä¸ºä¸åŒçš„å‰ç«¯å®¢æˆ·ç«¯(å¦‚ Webã€ç§»åŠ¨ç«¯ã€æ¡Œé¢ç«¯ç­‰)æä¾›ä¸“é—¨çš„åç«¯æœåŠ¡,è€Œä¸æ˜¯è®©æ‰€æœ‰å®¢æˆ·ç«¯å…±äº«åŒä¸€ä¸ªé€šç”¨çš„åç«¯ APIã€‚ 1. BFF çš„æ ¸å¿ƒæ¦‚å¿µ å®šåˆ¶åŒ–æœåŠ¡:BFF ä¸ºç‰¹å®šçš„å‰ç«¯å®¢æˆ·ç«¯æä¾›å®šåˆ¶åŒ–çš„ API,æ»¡è¶³å…¶ç‹¬ ã€

SPAï¼šjs => è¯·æ±‚æ¥å£ 3ä¸ªæ¥å£
BFFï¼šjs => node => è¯·æ±‚æ¥å£
{
  1ä¸ª
}
å°è£…æ¥å£ï¼Œå‡å°‘è¯·æ±‚
æœ€é‡è¦æ˜¯è®©nodeæ¸²æŸ“reactï¼ŒåŒæ„

# SPAã€Œæ˜¯æœ€æ…¢ã€æœ€å·®çš„å‰ç«¯æ¶æ„ï¼Œæœ€ç®€å•ã€
SPAæ¸²æŸ“é¡µé¢ç»è¿‡äº†å“ªäº›æ­¥éª¤
index.html
ä¸‰æ–¹ä»“åº“
-> main.js -> è·¯ç”± -> ç»„ä»¶ -> å‘è¯·æ±‚ -> æ¸²æŸ“è™šæ‹ŸDOM -> å¯¹æ¯”DOM -> äº‹ä»¶åˆæˆ -> å±•ç°å‡ºæ¥

# åˆ›å»ºç›®å½•ç»“æ„
åˆ›å»º mkdir YD-AI-BFF

cd YD-AI-BFF

npm init -y

YD-AI-BFF
|- assets
|- config
|- interface
|- logs
|- middlewares
|- routers
|- services
|- typings
|- views
|- .env
|- app.ts
|- package.json
|- tsconfig.json


tsconfig.json
```
{
  "compilerOptions": {
    "target": "ES2024",
    "noImplicitAny": true,
    "noImplicitThis": true,
    "experimentalDecorators": true,
    "esModuleInterop": true,
    "module": "NodeNext",
    "moduleResolution": "nodenext",
    "allowSyntheticDefaultImports": true,
    "typeRoots": ["typings"],
    "baseUrl": "./",
    "paths": {
      "@interfaces/*": ["interface/*"],
      "@config/*": ["config/*"],
      "@middlewares/*": ["middlewares/*"]
    }
  },
  "include": ["**/*"]
}
```

# IOC
IOC
DI
AOP

ä¸éœ€è¦import Aï¼ŒBï¼ŒCè¿™æ ·å†™äº†


D
class D {
  æ„é€ å‡½æ•°({A,B,C}) {
    //ä¾èµ–æ³¨å…¥
    A.éœ€è¦çš„æ–¹æ³•()ï¼›
    this.a = A;
  }

  logs() {
    this.a.éœ€è¦çš„æ–¹æ³•()
  }
}

yarn add awilix-koa awilix koa koa-router

yarn add @types/node ã€Œæ‰¾åˆ°__dirnameã€

yarn add @types/koa ã€Œæ‰¾åˆ°koaã€

yarn add @types/koa-router ã€Œæ‰¾åˆ°koa-routerã€

yarn add typescript

yarn add ts-node-dev --dev

yarn dev

yarn add co

yarn add @types/co

package.json
```
  "scripts": {
    "dev": "ts-node-dev --respawn --transpile-only app.ts"
  },
```

yarn add koa-swig ã€Œåç«¯çš„ä¸€ä¸ªæ¨¡æ¿ã€

routers/ApiController.ts
```
import { GET, route } from 'awilix-koa';
import Router from 'koa-router';
import { IApi } from '@interfaces/IApi';

@route('/api')
class ApiController {
  private apiService: IApi;
  constructor({ apiService }: { apiService: IApi }) {
    this.apiService = apiService;
  }
  @route('/list')
  @GET()
  async actionList(
    ctx: Router.IRouterContext,
    next: () => Promise<any>
  ): Promise<any> {
    const data = await this.apiService.getInfo();
    ctx.body = {
      data,
    };
  }
}
export default ApiController;
```

ApiService.ts
```
import { IApi } from '@interfaces/IApi';
import { IData } from '@interfaces/IData';

class ApiService implements IApi {
  getInfo() {
    //åŒºåˆ«å¼€ MPA å’Œ SPA
    // window.localStorage.get('info');
    // if(){}..
    return new Promise<IData>((resolve) => {
      resolve({
        item: 'æˆ‘æ˜¯åå°æ•°æ®',
        result: [1, 'next'],
      });
    });
  }
}
export default ApiService;
```

app.ts
```
import Koa from 'koa';
import { createContainer, Lifetime } from 'awilix';
import { scopePerRequest } from 'awilix-koa';

const app = new Koa();
const port = 3000;
const container = createContainer();
// æ‰€æœ‰çš„å¯ä»¥è¢«æ³¨å…¥çš„ä»£ç éƒ½åœ¨containerä¸­
container.loadModules([`${__dirname}/services/*.ts`], {
  formatName: 'camelCase',
  resolverOptions: {
    lifetime: Lifetime.SCOPED,
  },
});

// æ¯ä¸€æ¬¡ç”¨æˆ·è¯·æ±‚routerä¸­ éƒ½ä¼šä»å®¹å™¨ä¸­å–åˆ°æ³¨å…¥çš„æœåŠ¡
app.use(scopePerRequest(container));
// è®©æ‰€æœ‰çš„è·¯ç”±å…¨éƒ¨ç”Ÿæ•ˆ
app.use(loadControllers(`${__dirname}/routers/*.ts`));
app.listen(port, () => {
  console.log('YD Server BFFå¯åŠ¨æˆåŠŸ');
});
```

interface/IData.ts
```
import { IData } from './IData';

export interface IApi {
  getInfo(): Promise<IData>;
}
```

interface/IApi.ts
```
import { IData } from './IData';

export interface IApi {
  getInfo(): Promise<IData>;
}
```

routers/IndexController.ts
```
import { GET, route } from 'awilix-koa';
import { Context } from '@interfaces/IKoa';

@route('/')
class IndexController {
  @GET()
  async actionList(ctx: Context): Promise<void> {
    const data = await ctx.render('index', {
      data: 'æœåŠ¡ç«¯æ•°æ®',
    });
    console.log('ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹', data);

    ctx.body = data;
  }
}
export default IndexController;
```

interface/IKoa.ts
```
// interfaces/IKoa.ts

import * as Koa from 'koa';

// ç›´æ¥å®šä¹‰ render æ–¹æ³•çš„ç±»å‹
type RenderFunction = (
  view: string,
  options?: { [key: string]: any }
) => Promise<string>;

export interface Context extends Koa.Context {
  render: RenderFunction;
}
```

è‡ªå·±ç”¨AIå†™ä¸€ä¸ª@types/koa-swig çš„åŒ…ï¼Œå› ä¸ºæ²¡æœ‰äººå†™

typings/koa-swig.d.ts
```
declare module 'koa-swig' {
  import { Context } from 'koa';

  interface KoaSwigOptions {
    /**
     * Root directory for templates
     */
    root?: string;
    
    /**
     * Template cache options
     */
    cache?: boolean | 'memory';
    
    /**
     * Template file extension
     */
    ext?: string;
    
    /**
     * Whether to auto-escape template variables
     */
    autoescape?: boolean;
    
    /**
     * Custom filters for templates
     */
    filters?: { [key: string]: Function };
    
    /**
     * Custom tags for templates
     */
    tags?: { [key: string]: Function };
    
    /**
     * Template variable start and end delimiters
     */
    varControls?: [string, string];
    
    /**
     * Template tag start and end delimiters
     */
    tagControls?: [string, string];
    
    /**
     * Template comment start and end delimiters
     */
    cmtControls?: [string, string];
    
    /**
     * Local variables available to all templates
     */
    locals?: { [key: string]: any };
    
    /**
     * Custom loader function
     */
    loader?: Function;
    
    /**
     * Whether to write compiled templates to cache
     */
    writeBody?: boolean;
  }

  interface RenderedSwig {
    /**
     * Set local variables
     */
    setLocals(args: { [key: string]: any }): void;

    /**
     * Get local variable by key
     */
    getLocals(key: string): any;
    
    /**
     * Get all local variables
     */
    getLocals(): { [key: string]: any };
    
    /**
     * Set a single local variable
     */
    setLocal(key: string, value: any): void;
    
    /**
     * Set custom filter
     */
    setFilter(name: string, filter: Function): void;
    
    /**
     * Set custom tag
     */
    setTag(name: string, tag: Function): void;
    
    /**
     * Render template with given context
     */
    render(template: string, context?: { [key: string]: any }): string;
    
    /**
     * Render template file with given context
     */
    renderFile(path: string, context?: { [key: string]: any }): string;
    
    /**
     * Compile template string
     */
    compile(template: string, options?: any): Function;
    
    /**
     * Compile template file
     */
    compileFile(path: string, options?: any): Function;
  }

  interface SwigRenderer {
    (view: string, options?: { [key: string]: any }): Promise<string>;
  }

  interface KoaSwigRenderer {
    (settings?: KoaSwigOptions): (
      ctx: Context
    ) => Generator<Promise<string>, void, unknown>;
  }

  interface KoaSwigMiddleware {
    /**
     * Render template
     */
    render(view: string, locals?: { [key: string]: any }): Promise<string>;
    
    /**
     * Set response body with rendered template
     */
    renderView(view: string, locals?: { [key: string]: any }): Promise<void>;
  }

  // Extend Koa Context to include render methods
  module 'koa' {
    interface Context {
      render: KoaSwigMiddleware['render'];
      renderView: KoaSwigMiddleware['renderView'];
    }
  }

  const renderer: KoaSwigRenderer & {
    swig: RenderedSwig;
  };

  export = renderer;
}
```

yarn add lodash

config/index.ts
```
import _ from 'lodash';
import { join } from 'path';

let config = {
  viewDir: join(__dirname, '..', 'views'),
  staticDir: join(__dirname, '..', 'assets'),
  port: 8081,
  memoryFlag: false,
};
if (process.env.NODE_ENV === 'development') {
  let localConfig = {
    port: 8081,
  };
  config = _.assignIn(config, localConfig);
}
if (process.env.NODE_ENV === 'production') {
  let prodConfig = {
    port: 8082,
    memoryFlag: 'memory',
  };
  config = _.assignIn(config, prodConfig);
}

export default config;
```

yarn add module-alias

yarn add @types/module-alias

app.ts
```
+ import { addAliases } from 'module-alias';
+ addAliases({
+  '@root': __dirname,
+  '@interfaces': `${__dirname}/interface`,
+  '@config': `${__dirname}/config`,
+  '@middlewares': `${__dirname}/middlewares`,
+ });
import Koa from 'koa';
import { createContainer, Lifetime } from 'awilix';
import co from 'co';
import render from 'koa-swig';
import config from '@config/index';
import { loadControllers, scopePerRequest } from 'awilix-koa';
+ // koaä¸­æ²¡æœ‰å®ç°çš„è·¯ç”±é‡å®šå‘åˆ°index.hmlt
+ import { historyApiFallback } from 'koa2-connect-history-api-fallback';

const app = new Koa();
+ const { port, viewDir, memoryFlag, staticDir } = config;
const container = createContainer();
// æ‰€æœ‰çš„å¯ä»¥è¢«æ³¨å…¥çš„ä»£ç éƒ½åœ¨containerä¸­
container.loadModules([`${__dirname}/services/*.ts`], {
  formatName: 'camelCase',
  resolverOptions: {
    lifetime: Lifetime.SCOPED,
  },
});

// æ¯ä¸€æ¬¡ç”¨æˆ·è¯·æ±‚routerä¸­ éƒ½ä¼šä»å®¹å™¨ä¸­å–åˆ°æ³¨å…¥çš„æœåŠ¡
app.use(scopePerRequest(container));
app.context.render = co.wrap(
  render({
    root: viewDir,
    autoescape: true,
    cache: <'memory' | false>memoryFlag,
    writeBody: false,
    ext: 'html',
  })
);
+ app.use(historyApiFallback({ index: '', whiteList: ['/api'] }));
// è®©æ‰€æœ‰çš„è·¯ç”±å…¨éƒ¨ç”Ÿæ•ˆ
app.use(loadControllers(`${__dirname}/routers/*.ts`));
app.listen(port, () => {
  console.log('YD Server BFFå¯åŠ¨æˆåŠŸ');
});
```

1. æ¥ä¸‹æ¥æŠŠ YD-AI-DAPP é¡¹ç›®ä¸‹çš„dist/ä¸‹çš„æ–‡ä»¶å¤¹ copy åˆ° views/
2. æŠŠscriptså’Œstyles æ”¾åˆ° assets/æ–‡ä»¶å¤¹ä¸‹
3. app.ts ä¸­æŒ‡å®šä¸€ä¸‹é™æ€èµ„æºæ–‡ä»¶

yarn dev å°±å¯ä»¥å¯åŠ¨ä¸€ä¸ªSPA + MPA çš„é¡¹ç›®äº†ï¼Œåˆ°æ—¶åˆ·æ–°å‡ºç°404

æ‰€ä»¥å®‰é‡å®šå‘çš„åŒ…ï¼ŒæŠŠé™¤äº†apiçš„è·¯ç”±ï¼Œéƒ½é‡å®šå‘åˆ°é¦–é¡µ

yarn add koa2-connect-history-api-fallback

yarn add koa-static

yarn add @types/koa-static

app.ts
```
import { addAliases } from 'module-alias';
addAliases({
  '@root': __dirname,
  '@interfaces': `${__dirname}/interface`,
  '@config': `${__dirname}/config`,
  '@middlewares': `${__dirname}/middlewares`,
});
import Koa from 'koa';
import { createContainer, Lifetime } from 'awilix';
import co from 'co';
import render from 'koa-swig';
import config from '@config/index';
+ import serve from 'koa-static';
import { loadControllers, scopePerRequest } from 'awilix-koa';

const app = new Koa();
const { port, viewDir, memoryFlag, staticDir } = config;
+ // é™æ€èµ„æºç”Ÿæ•ˆèŠ‚ç‚¹
+ app.use(serve(staticDir));

const container = createContainer();
// æ‰€æœ‰çš„å¯ä»¥è¢«æ³¨å…¥çš„ä»£ç éƒ½åœ¨containerä¸­
container.loadModules([`${__dirname}/services/*.ts`], {
  formatName: 'camelCase',
  resolverOptions: {
    lifetime: Lifetime.SCOPED,
  },
});

// æ¯ä¸€æ¬¡ç”¨æˆ·è¯·æ±‚routerä¸­ éƒ½ä¼šä»å®¹å™¨ä¸­å–åˆ°æ³¨å…¥çš„æœåŠ¡
app.use(scopePerRequest(container));
app.context.render = co.wrap(
  render({
    root: viewDir,
    autoescape: true,
    cache: <'memory' | false>memoryFlag,
    writeBody: false,
    ext: 'html',
  })
);

app.use(historyApiFallback({ index: '/', whiteList: ['/api'] }));
// è®©æ‰€æœ‰çš„è·¯ç”±å…¨éƒ¨ç”Ÿæ•ˆ
app.use(loadControllers(`${__dirname}/routers/*.ts`));
app.listen(port, () => {
  console.log('YD Server BFFå¯åŠ¨æˆåŠŸ');
});
```

ç”±å‰ç«¯æœåŠ¡æ”¹ä¸ºåç«¯æœåŠ¡ï¼Œpm2ç®¡ç†

pm2é…ç½®

npm install pm2 -g

pm2 start
ecosystem.config.js
```
// pm2.config.js
module.exports = {
  apps: [
    {
      name: 'yd-app',
      script: './app.ts',
      instances: 1,
      exec_mode: 'cluster',
      interpreter: './node_modules/.bin/ts-node', // ä½¿ç”¨æœ¬åœ° ts-node
      autorestart: true,
      watch: true,
      env: {
        NODE_ENV: 'development',
        TS_NODE_PROJECT: './tsconfig.json',
      },
      env_production: {
        NODE_ENV: 'production',
        TS_NODE_PROJECT: './tsconfig.json',
      },
      error_file: './logs/yd-app-error.log',
      out_file: './logs/yd-app-out.log',
      merge_logs: true,
      log_date_format: 'YYYY-MM-DD HH:mm:ss',
    },
  ],
};
```